# ğŸš€ GCP Compute Engine ë°°í¬ ì›Œí¬í”Œë¡œìš°
# main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ GCP VMì— ë°°í¬í•©ë‹ˆë‹¤

name: Deploy to GCP

# ì–¸ì œ ì‹¤í–‰í• ì§€ ì •ì˜
on:
  push:
    branches: [ master ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ì„ ì„ íƒí•˜ì„¸ìš”'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

# í™˜ê²½ ë³€ìˆ˜
env:
  REGISTRY: docker.io
  IMAGE_NAME: github-actions-demo

jobs:
  # GCP VM ë°°í¬
  deploy-gcp:
    name: GCP VM ë°°í¬
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Docker Hubì—ì„œ ì´ë¯¸ì§€ í’€
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        
    - name: GCP VMì— SSH ì—°ê²° ë° ë°°í¬
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          docker stop github-actions-demo || true
          docker rm github-actions-demo || true
          
          # Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ í’€
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d \
            --name github-actions-demo \
            --restart unless-stopped \
            -p 3000:3000 \
            -e NODE_ENV=production \
            ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # í—¬ìŠ¤ ì²´í¬
          sleep 10
          curl -f http://localhost:3000/health || exit 1
          
          echo "âœ… GCP VM ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          
    - name: ë°°í¬ ìƒíƒœ í™•ì¸
      run: |
        echo "ğŸ” GCP VM ë°°í¬ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
        echo "ğŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://${{ secrets.GCP_VM_HOST }}:3000"
        
    - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        echo "âœ… GCP VM ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://${{ secrets.GCP_VM_HOST }}:3000"
        echo "ğŸ“Š í—¬ìŠ¤ ì²´í¬: http://${{ secrets.GCP_VM_HOST }}:3000/health"
        echo "ğŸ“ˆ ë©”íŠ¸ë¦­: http://${{ secrets.GCP_VM_HOST }}:3000/metrics"
