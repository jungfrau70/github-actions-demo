
name: CI Pipeline  # ì´ ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„

# ğŸ¯ ì–¸ì œ ì‹¤í–‰í• ê¹Œ? (íŠ¸ë¦¬ê±° ì„¤ì •)
on:
  push:
    branches: [ main, develop ]  # main, develop ë¸Œëœì¹˜ì— ì½”ë“œë¥¼ ì˜¬ë¦´ ë•Œ
  pull_request:
    branches: [ main ]           # main ë¸Œëœì¹˜ë¡œ PRì„ ì˜¬ë¦´ ë•Œ

env:
  NODE_VERSION: '18'  # ê¸°ë³¸ Node.js ë²„ì „

jobs:
  # ğŸ§ª 1ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê°€ì¥ ì¤‘ìš”!)
  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest  # Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰
    
    strategy:
      matrix:
        node-version: [16, 18, 20]  # 3ê°œ ë²„ì „ì—ì„œ ëª¨ë‘ í…ŒìŠ¤íŠ¸
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4  # GitHubì—ì„œ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ê¸°
      
    - name: Node.js ${{ matrix.node-version }} ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'  # npm ìºì‹œ ì‚¬ìš©ìœ¼ë¡œ ì†ë„ í–¥ìƒ
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci  # package-lock.json ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•œ ë²„ì „ ì„¤ì¹˜
      
    - name: ë¦°íŒ… ì‹¤í–‰
      run: npm run lint  # ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
      
    - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm test  # ì‹¤ì œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      
    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()  # í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•´ë„ ê²°ê³¼ ì €ì¥
      with:
        name: test-results-node-${{ matrix.node-version }}
        path: test-results/
        retention-days: 30

  # ğŸ—ï¸ 2ë‹¨ê³„: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
  build:
    name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: test  # í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•œ í›„ì—ë§Œ ì‹¤í–‰
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      run: npm run build
      
    - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          src/
          package.json
          package-lock.json
        retention-days: 30

  # ğŸ”’ 3ë‹¨ê³„: ë³´ì•ˆ ìŠ¤ìº” (ì•ˆì „ì„± í™•ì¸)
  security-scan:
    name: ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    needs: test  # í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•œ í›„ì—ë§Œ ì‹¤í–‰
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
      run: npm audit --audit-level moderate
      
    - name: ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº”
      run: npx audit-ci --moderate