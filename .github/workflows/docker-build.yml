# ğŸ³ Docker ì´ë¯¸ì§€ ìë™ ë¹Œë“œ ë° í‘¸ì‹œ
# main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ Docker Hubì— ì´ë¯¸ì§€ë¥¼ ìë™ìœ¼ë¡œ í‘¸ì‹œí•©ë‹ˆë‹¤

name: Docker Build and Push

# ì–¸ì œ ì‹¤í–‰í• ì§€ ì •ì˜
on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

# í™˜ê²½ ë³€ìˆ˜
env:
  REGISTRY: docker.io
  IMAGE_NAME: github-actions-demo

jobs:
  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build-and-push:
    name: Docker ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Docker Hub ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: Docker ë¹Œë“œ ë° í‘¸ì‹œ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        
    - name: Docker ë¹Œë“œ ë° í‘¸ì‹œ (ê°œë°œìš©)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.dev
        push: true
        tags: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:dev
        labels: ${{ steps.meta.outputs.labels }}
        
        
    - name: Docker ë¹Œë“œ ë° í‘¸ì‹œ (í…ŒìŠ¤íŠ¸ìš©)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.test
        push: true
        tags: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:test
        labels: ${{ steps.meta.outputs.labels }}
        
    - name: Docker ë¹Œë“œ ë° í‘¸ì‹œ (ë©€í‹°ìŠ¤í…Œì´ì§€)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.multistage
        push: true
        tags: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:multistage
        labels: ${{ steps.meta.outputs.labels }}
        
    - name: ì´ë¯¸ì§€ ì •ë³´ ì¶œë ¥
      run: |
        echo "âœ… Docker ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë¹Œë“œë˜ê³  í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“¦ ì´ë¯¸ì§€ íƒœê·¸: ${{ steps.meta.outputs.tags }}"
        echo "ğŸ”— Docker Hub: https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"