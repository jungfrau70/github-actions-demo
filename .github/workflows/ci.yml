# ğŸ”„ CI ì›Œí¬í”Œë¡œìš° (Continuous Integration)
# ì½”ë“œê°€ í‘¸ì‹œë  ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ê³  ë¹Œë“œí•©ë‹ˆë‹¤

name: CI Pipeline

# ì–¸ì œ ì‹¤í–‰í• ì§€ ì •ì˜
on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]

# ë³‘ë ¬ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ì‘ì—…ë“¤
jobs:
  # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  code-quality:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm install
      
    - name: ì½”ë“œ ë¦°íŒ…
      run: npm run lint
      
    - name: ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬
      run: npm run format:check

  # 2. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm install
      
    - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm run test:unit
      
    - name: í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm run test:integration
      
    - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ìƒì„±
      run: npm run test:coverage
      
    - name: ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info

  # 3. ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    name: ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm install
      
    - name: ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
      run: npm audit --audit-level moderate
      
    - name: ì˜ì¡´ì„± ë¼ì´ì„ ìŠ¤ ê²€ì‚¬
      run: npm run license:check

  # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ
  docker-build:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: [code-quality, test, security-scan]
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Docker ë¹Œë“œ
      run: |
        docker build -f Dockerfile -t github-actions-demo:latest .
        docker build -f Dockerfile.dev -t github-actions-demo:dev .
        docker build -f Dockerfile.test -t github-actions-demo:test .
        
    - name: ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
      run: |
        docker images github-actions-demo --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
        
    - name: ì´ë¯¸ì§€ ì •ë³´ í™•ì¸
      run: |
        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
        docker images github-actions-demo --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
