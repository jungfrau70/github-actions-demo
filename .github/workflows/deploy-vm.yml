# ğŸš€ VM ë°°í¬ ì›Œí¬í”Œë¡œìš°
# main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ VMì— ë°°í¬í•©ë‹ˆë‹¤

name: Deploy to VM

# ì–¸ì œ ì‹¤í–‰í• ì§€ ì •ì˜
on:
  push:
    branches: [ main ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ì„ ì„ íƒí•˜ì„¸ìš”'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

# í™˜ê²½ ë³€ìˆ˜
env:
  REGISTRY: docker.io
  IMAGE_NAME: github-actions-demo

jobs:
  # VM ë°°í¬
  deploy:
    name: VM ë°°í¬
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Docker Hubì—ì„œ ì´ë¯¸ì§€ í’€
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        
    - name: VMì— SSH ì—°ê²° ë° ë°°í¬
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          docker stop github-actions-demo || true
          docker rm github-actions-demo || true
          
          # Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ í’€
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d \
            --name github-actions-demo \
            --restart unless-stopped \
            -p 3000:3000 \
            -e NODE_ENV=production \
            ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # í—¬ìŠ¤ ì²´í¬
          sleep 10
          curl -f http://localhost:3000/health || exit 1
          
          echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          
    - name: ë°°í¬ ìƒíƒœ í™•ì¸
      run: |
        echo "ğŸ” ë°°í¬ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
        # ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ëª¨ë‹ˆí„°ë§ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒíƒœ í™•ì¸
        
    - name: ì•Œë¦¼ ì „ì†¡
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author,action,eventName,ref,workflow