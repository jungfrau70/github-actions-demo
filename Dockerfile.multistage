# ğŸ—ï¸ ë©€í‹°ìŠ¤í…Œì´ì§€ Dockerfile (ê³ ê¸‰ ìµœì í™”)
# 1ë‹¨ê³„: ë¹Œë“œ í™˜ê²½ ì¤€ë¹„ (ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ)
FROM node:18-alpine AS builder
# ì™œ alpine? -> ë§¤ìš° ê°€ë²¼ìš´ Linux ë°°í¬íŒ (ë³´ì•ˆì„± + ì†ë„)

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# íŒ¨í‚¤ì§€ íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬ (ìºì‹œ ìµœì í™”)
COPY package*.json ./

# ì˜ì¡´ì„± ì„¤ì¹˜ (package-lock.jsonì´ ìˆìœ¼ë©´ ci, ì—†ìœ¼ë©´ install)
RUN if [ -f package-lock.json ]; then \
        npm ci --omit=dev && npm cache clean --force; \
    else \
        npm install --omit=dev && npm cache clean --force; \
    fi

# ğŸš€ 2ë‹¨ê³„: ëŸ°íƒ€ì„ í™˜ê²½ (ì‹¤ì œ ì‹¤í–‰ìš©)
FROM node:18-alpine AS runtime

# ğŸ”’ ë³´ì•ˆì„ ìœ„í•œ ë¹„root ì‚¬ìš©ì ìƒì„±
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001
# ì™œ ë¹„root? -> ë³´ì•ˆìƒ root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•˜ë©´ ìœ„í—˜

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì˜ì¡´ì„± ë³µì‚¬ (ë¹Œë“œ ë‹¨ê³„ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
COPY --from=builder /app/node_modules ./node_modules

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ (ì†Œìœ ì ë³€ê²½)
COPY --chown=nextjs:nodejs . .

# ì‚¬ìš©ì ë³€ê²½ (ë³´ì•ˆ)
USER nextjs

# í¬íŠ¸ ë…¸ì¶œ (ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ)
EXPOSE 3000

# ğŸ¥ í—¬ìŠ¤ ì²´í¬ (ì»¨í…Œì´ë„ˆê°€ ì‚´ì•„ìˆëŠ”ì§€ í™•ì¸)
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"

# ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
CMD ["node", "src/app.js"]
